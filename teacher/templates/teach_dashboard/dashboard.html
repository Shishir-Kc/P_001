{% extends 'teach_base/base.html' %}
{% load static %}
{% load teach_group_filter %}

{% block title %}Teacher Dashboard - Modern Design{% endblock %}

{% block header_title %}Dashboard{% endblock %}

{% block user_avatar_mobile %}  {% if teacher.teacher_image %} {{teacher.teacher_image.url}} {% else %} {% static 'teacher/images/default_user.png' %} {% endif %} {% endblock %}

{% block user_avatar %} {% if teacher.teacher_image %} {{teacher.teacher_image.url}} {% else %} {% static 'teacher/images/default_user.png' %} {% endif %}  {% endblock %}

{% block user_name %} {{teacher.first_name|default:"hahaha"}}  {% endblock %}

{% block user_display_name %} {{teacher.name}} {% endblock %}
 
{% block user_role %} 
    {% if teacher.head_teacher%}
    Head Teacher of {{teacher.head_teacher}}
    {% else %}
    Teacher
    {% endif %}
{% endblock %}

{% block page_title %}Dashboard{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'teacher/css/dashboard.css' %}">
<style>
    /* Profile Image Upload Functionality - FIXED */
    .profile-image-container {
        position: relative;
        display: inline-block;
        cursor: pointer;
    }
    
    .profile-image-container img {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        object-fit: cover;
        border: 3px solid var(--accent-color);
        transition: all 0.3s ease;
        display: block;
    }
    
    /* Upload Overlay - FIXED HOVER */
    .upload-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        border-radius: 50%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
        cursor: pointer;
        color: white;
        font-size: 14px;
        font-weight: 500;
        z-index: 10;
    }

    /* IMPORTANT: This makes the hover work */
    .profile-image-container:hover .upload-overlay {
        opacity: 1;
        visibility: visible;
    }

    .upload-overlay svg {
        width: 24px;
        height: 24px;
        margin-bottom: 6px;
        fill: white;
    }

    .upload-overlay span {
        font-size: 12px;
        text-align: center;
        color: white;
    }
    
    /* Hidden file input */
    .file-input {
        display: none;
    }
    
    /* Upload Modal */
    .upload-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
    }
    
    .upload-modal.active {
        opacity: 1;
        visibility: visible;
    }
    
    .upload-modal-content {
        background: var(--bg-primary);
        border-radius: 12px;
        padding: 2rem;
        max-width: 500px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
        position: relative;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }
    
    .modal-close {
        position: absolute;
        top: 1rem;
        right: 1rem;
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: var(--text-secondary);
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: all 0.3s ease;
    }
    
    .modal-close:hover {
        background: var(--bg-secondary);
        color: var(--text-primary);
    }
    
    .upload-modal h3 {
        color: var(--text-primary);
        font-size: 1.25rem;
        font-weight: 600;
        margin-bottom: 1rem;
        text-align: center;
    }
    
    /* File Drop Zone */
    .file-drop-zone {
        border: 2px dashed var(--border-color);
        border-radius: 8px;
        padding: 2rem;
        text-align: center;
        margin-bottom: 1rem;
        transition: all 0.3s ease;
        cursor: pointer;
    }
    
    .file-drop-zone:hover,
    .file-drop-zone.dragover {
        border-color: var(--accent-color);
        background: var(--bg-secondary);
    }
    
    .file-drop-zone svg {
        width: 48px;
        height: 48px;
        color: var(--accent-color);
        margin-bottom: 1rem;
    }
    
    .file-drop-zone p {
        color: var(--text-secondary);
        margin: 0;
        font-size: 0.875rem;
    }
    
    .file-drop-zone .primary-text {
        color: var(--text-primary);
        font-weight: 500;
        font-size: 1rem;
        margin-bottom: 0.5rem;
    }
    
    /* File Preview */
    .file-preview {
        display: none;
        text-align: center;
        margin-bottom: 1rem;
    }
    
    .file-preview.active {
        display: block;
    }
    
    .preview-image {
        width: 150px;
        height: 150px;
        border-radius: 50%;
        object-fit: cover;
        border: 3px solid var(--accent-color);
        margin-bottom: 1rem;
    }
    
    .file-info {
        background: var(--bg-secondary);
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
    }
    
    .file-info p {
        margin: 0.25rem 0;
        font-size: 0.875rem;
        color: var(--text-secondary);
    }
    
    .file-info .file-name {
        color: var(--text-primary);
        font-weight: 500;
    }
    
    /* Validation Messages */
    .validation-message {
        padding: 0.75rem;
        border-radius: 6px;
        margin-bottom: 1rem;
        font-size: 0.875rem;
        text-align: center;
        display: none;
    }
    
    .validation-message.error {
        background: #fee;
        color: #c53030;
        border: 1px solid #fed7d7;
    }
    
    .validation-message.success {
        background: #f0fff4;
        color: #2f855a;
        border: 1px solid #c6f6d5;
    }
    
    .validation-message.warning {
        background: #fffbeb;
        color: #d69e2e;
        border: 1px solid #faf089;
    }
    
    /* Modal Buttons */
    .modal-buttons {
        display: flex;
        gap: 1rem;
        justify-content: center;
        margin-top: 1rem;
    }
    
    .btn {
        padding: 0.75rem 1.5rem;
        border-radius: 6px;
        border: none;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 0.875rem;
    }
    
    .btn-primary {
        background: var(--accent-color);
        color: white;
    }
    
    .btn-primary:hover {
        opacity: 0.9;
        transform: translateY(-1px);
    }
    
    .btn-primary:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
    }
    
    .btn-secondary {
        background: var(--bg-secondary);
        color: var(--text-primary);
        border: 1px solid var(--border-color);
    }
    
    .btn-secondary:hover {
        background: var(--bg-tertiary);
    }

    /* Dashboard Columns Layout */
    .dashboard-columns {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
        margin-bottom: 2rem;
    }

    .left-column {
        grid-column: 1;
    }

    .right-column {
        grid-column: 2;
    }

    .dashboard-columns.single-column {
        grid-template-columns: 1fr;
    }

    .dashboard-columns.single-column .left-column {
        grid-column: 1;
    }

    /* ========================================
       PENDING REQUESTS SECTION - SCROLLABLE
       ======================================== */
    .pending-requests-section {
        background: var(--bg-primary);
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: var(--shadow);
        border: 1px solid var(--border-color);
        display: flex;
        flex-direction: column;
        max-height: 600px; /* Fixed max height for the entire section */
    }

    .pending-requests-section h2 {
        margin: 0 0 1rem 0;
        font-size: 1.25rem;
        color: var(--text-primary);
        padding-bottom: 0.75rem;
        border-bottom: 2px solid var(--border-color);
        flex-shrink: 0;
    }

    /* Scrollable Container */
    .student-list-container {
        flex: 1;
        overflow: hidden;
        position: relative;
    }

    .student-list-scrollable {
        max-height: 480px; /* Height for approximately 3 student cards */
        overflow-y: auto;
        padding-right: 8px;
    }

    /* Custom Scrollbar Styling */
    .student-list-scrollable::-webkit-scrollbar {
        width: 6px;
    }

    .student-list-scrollable::-webkit-scrollbar-track {
        background: var(--bg-secondary);
        border-radius: 10px;
    }

    .student-list-scrollable::-webkit-scrollbar-thumb {
        background: var(--text-muted);
        border-radius: 10px;
        transition: background 0.3s ease;
    }

    .student-list-scrollable::-webkit-scrollbar-thumb:hover {
        background: var(--text-secondary);
    }

    /* Firefox Scrollbar */
    .student-list-scrollable {
        scrollbar-width: thin;
        scrollbar-color: var(--text-muted) var(--bg-secondary);
    }

    /* Scroll Indicator (optional fade effect at bottom) */
    .student-list-container::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        right: 8px;
        height: 30px;
        background: linear-gradient(to bottom, transparent, var(--bg-primary));
        pointer-events: none;
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .student-list-container.has-scroll::after {
        opacity: 1;
    }

    /* Student List */
    .student-list {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    /* Student Card Styling */
    .student-card {
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 1.25rem;
        display: flex;
        align-items: center;
        gap: 1rem;
        transition: all 0.2s ease;
    }

    .student-card:last-child {
        margin-bottom: 0;
    }

    .student-card:hover {
        background: var(--bg-primary);
        box-shadow: var(--shadow-lg);
        transform: translateY(-2px);
        border-color: var(--accent-color);
    }

    .student-avatar {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        object-fit: cover;
        border: 3px solid var(--bg-primary);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        flex-shrink: 0;
    }

    .student-info {
        flex: 1;
        min-width: 0;
    }

    .student-name {
        font-size: 1rem;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 0.5rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .student-details {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }

    .student-detail {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.8rem;
        color: var(--text-secondary);
    }

    .student-detail i {
        width: 14px;
        color: var(--text-muted);
        font-size: 0.75rem;
    }

    .student-detail span {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    /* Action Buttons */
    .student-actions {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        flex-shrink: 0;
    }

    .action-btn {
        padding: 0.5rem 1rem;
        border: none;
        border-radius: 6px;
        font-size: 0.8rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.35rem;
        min-width: 90px;
    }

    .accept-btn {
        background-color: var(--success-color, #10b981);
        color: white;
    }

    .accept-btn:hover {
        background-color: #059669;
        transform: scale(1.05);
    }

    .reject-btn {
        background-color: var(--danger-color, #ef4444);
        color: white;
    }

    .reject-btn:hover {
        background-color: #dc2626;
        transform: scale(1.05);
    }

    /* Pending Count Badge */
    .pending-count {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        background: var(--accent-color);
        color: white;
        font-size: 0.75rem;
        font-weight: 600;
        padding: 0.25rem 0.5rem;
        border-radius: 12px;
        margin-left: 0.5rem;
    }

    /* Status styling for rejected */
    .status.rejected {
        background-color: var(--danger-color);
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
    }

    /* Empty state styling */
    .empty-state {
        text-align: center;
        padding: 3rem 1rem;
        color: var(--text-secondary);
    }

    .empty-state i {
        font-size: 3rem;
        margin-bottom: 1rem;
        color: var(--text-muted);
    }

    .empty-state h3 {
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
        color: var(--text-primary);
    }

    .empty-state p {
        margin: 0;
        font-size: 0.9rem;
    }

    .no-results {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 40vh;
        text-align: center;
        gap: 1rem;
        color: var(--text-secondary);
    }

    .no-results-icon {
        font-size: 3rem;
        color: var(--text-secondary);
    }

    /* Responsive adjustments */
    @media (max-width: 992px) {
        .student-card {
            flex-wrap: wrap;
        }

        .student-info {
            flex: 1 1 calc(100% - 80px);
        }

        .student-actions {
            flex-direction: row;
            width: 100%;
            margin-top: 0.5rem;
        }

        .action-btn {
            flex: 1;
        }
    }

    @media (max-width: 768px) {
        .dashboard-columns {
            grid-template-columns: 1fr;
            gap: 1rem;
        }

        .left-column,
        .right-column {
            grid-column: 1;
        }

        .pending-requests-section {
            max-height: 500px;
        }

        .student-list-scrollable {
            max-height: 380px;
        }

        .student-card {
            flex-direction: column;
            text-align: center;
            gap: 1rem;
            padding: 1rem;
        }

        .student-info {
            flex: none;
            width: 100%;
        }

        .student-details {
            align-items: center;
        }

        .student-actions {
            width: 100%;
            justify-content: center;
        }

        .action-btn {
            flex: 1;
            justify-content: center;
        }

        .profile-image-container img {
            width: 80px;
            height: 80px;
        }
    }

    /* Dark mode adjustments */
    [data-theme="dark"] .upload-modal-content,
    [data-theme="dark"] .file-info {
        background: var(--bg-secondary);
    }

    [data-theme="dark"] .student-card {
        background: var(--bg-tertiary);
    }

    [data-theme="dark"] .student-card:hover {
        background: var(--bg-secondary);
    }
</style>
{% endblock %}

{% block content %}
<div class="content-section active" id="dashboard-content">
    <div class="content-header">
        <h1>Dashboard</h1>
    </div>
    
    <section class="student-profile">
        <div class="profile-card">
            <div class="profile-image-container" id="profileContainer">
                <img id="currentProfileImage" src="
                
                {% if teacher.teacher_image %}
                  {{teacher.teacher_image.url}}
                {% else %}
                {% static 'teacher/images/default_user.png' %}
                {% endif %}
                
                " alt="Teacher Profile">
                <!-- Upload Overlay -->
                <div class="upload-overlay" id="uploadTrigger">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M9,16V10H5L12,3L19,10H15V16H9M5,20V18H19V20H5Z"/>
                    </svg>
                    <span>Change Photo</span>
                </div>
            </div>
            
            <div class="profile-info">
                <h2>{{teacher.first_name}} {{teacher.last_name}}</h2>
                <p>
                    {% if teacher.subject.count == 1 %}
                 Subject:
                    {% elif teacher.subject.count > 1 %}
                 Subjects:
                    {% else %}
                      No subjects assigned.
                    {% endif %}

                 {% if teacher.subject.count > 0 %}
                    {% for subj in teacher.subject.all %}
                    {{ subj }}{% if not forloop.last %}, {% endif %}
                 {% endfor %}
                {% endif %}
                </p>
                <p>Contact: {{teacher.contact}}</p>
            </div>
        </div>
    </section>

    <!-- Upload Modal -->
    <div class="upload-modal" id="uploadModal">
        <div class="upload-modal-content">
            <button class="modal-close" id="closeModal">&times;</button>
            <h3>Update Profile Picture</h3>
            
            <!-- Upload Form -->
            <form id="profileUploadForm" method="post" enctype="multipart/form-data" action="{% url 'teacher:update_profile_pic' %}">
                {% csrf_token %}
                
                <!-- File Drop Zone -->
                <div class="file-drop-zone" id="dropZone">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z" />
                        <path d="M12,11L16,15H13V19H11V15H8L12,11Z" />
                    </svg>
                    <p class="primary-text">Click to select image or drag & drop</p>
                    <p>Maximum size: 200KB</p>
                    <p>Supported formats: JPEG, PNG</p>
                </div>
                
                <!-- Hidden File Input -->
                <input type="file" id="profileFileInput" name="teacher_image" class="file-input" accept="image/*" required>
                
                <!-- File Preview -->
                <div class="file-preview" id="filePreview">
                    <img id="previewImage" class="preview-image" src="" alt="Preview">
                    <div class="file-info" id="fileInfo">
                        <p class="file-name" id="fileName"></p>
                        <p id="fileSize"></p>
                        <p id="fileType"></p>
                    </div>
                </div>
                
                <!-- Validation Message -->
                <div id="validationMessage"></div>
                
                <!-- Modal Buttons -->
                <div class="modal-buttons">
                    <button type="button" class="btn btn-secondary" id="cancelUpload">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="uploadButton" disabled>Upload Image</button>
                </div>
            </form>
        </div>
    </div>

    <section class="academic-overview">
        <h2>Academic Overview</h2>
        <div class="stats-grid">
            <div class="stat-card">
                <h3>Classes</h3>
                <div class="stat-value">{{ teacher.teacher_class.count }}</div>
            </div>
            <div class="stat-card">
                <h3>Students</h3>
                <div class="stat-value">{{std_num}}</div>
            </div>
            <div class="stat-card">
                <h3>Assignments Uploaded</h3>
                <div class="stat-value">{{teacher.assignments.count}}</div>
            </div>
        </div>
    </section>

    <div class="dashboard-columns"> 
        <section class="notices-section left-column">
            <h2>Project Notifications</h2>
            <div class="notice-list">
                {% if projects %} 
                    {% for project in projects %} 
                        <div class="notice-item">
                            <div class="notice-icon">
                                <i class="fas fa-tasks"></i>
                            </div>
                            <p>{{project.title}}</p>
                            {% if project.status|lower == 'pending' %}
                                <div class="status pending">{{project.status}}</div>
                            {% elif project.status|lower == 'approved' %}
                                <div class="status completed">{{project.status}}</div>
                            {% else %}
                                <div class="status rejected">{{project.status}}</div>
                            {% endif %}
                        </div>
                    {% endfor %}
                {% else %}
                    <div class="no-results" id="noResults">
                        <div class="no-results-content">
                            <i class="fas fa-search no-results-icon"></i>
                            <h3 class="no-results-title">Awh Snap! Projects have not been uploaded!</h3>
                            <p class="no-results-text">We will notify you when it is uploaded.</p>
                        </div>
                    </div>
                {% endif %}
            </div>
        </section>
        
        {% if teacher.head_teacher != None %} 
        <section class="pending-requests-section right-column" id="pendingRequestsSection">
            <h2>
                Pending Student Requests
                {% with pending_count=students|length %}
                    {% if pending_count > 0 %}
                        <span class="pending-count">{{ pending_count }}</span>
                    {% endif %}
                {% endwith %}
            </h2>
            <div class="student-list-container" id="studentListContainer">
                <div class="student-list-scrollable" id="pendingStudentsList">
                    <div class="student-list">
                        {% if students %}
                            {% for student in students %}
                                {% if student.joined == False %}
                                    <div class="student-card" data-student-name="{{ student.first_name|lower }} {{ student.last_name|lower }}">
                                        <img src="{% if student.student_profile %}{{ student.student_profile.url }}{% else %}{% if student.Gender == 'Male' %}{% static 'teacher/images/male.png' %}{% else %}{% static 'teacher/images/female.png' %}{% endif %}{% endif %}" 
                                             alt="{{ student.first_name }}" class="student-avatar">
                                        <div class="student-info">
                                            <div class="student-name">{{ student.first_name }} {{ student.last_name }}</div>
                                            <div class="student-details">
                                                <div class="student-detail">
                                                    <i class="fas fa-envelope"></i>
                                                    <span>{{ student.email|default:"No email" }}</span>
                                                </div>
                                                <div class="student-detail">
                                                    <i class="fas fa-phone"></i>
                                                    <span>{{ student.student_contact|default:"No contact" }}</span>
                                                </div>
                                                <div class="student-detail">
                                                    <i class="fas fa-calendar"></i>
                                                    <span>Requested: {{ student.account_created_at|date:"M d, Y" }}</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="student-actions">
                                            <form method="post" style="display: inline;" action="{% url 'teacher:accept_request' %}">
                                                {% csrf_token %}
                                                <input type="hidden" name="student_id" value="{{ student.id }}">
                                                <input type="hidden" name="action" value="accept">
                                                <button type="submit" class="action-btn accept-btn">
                                                    <i class="fas fa-check"></i>
                                                    Accept
                                                </button>
                                            </form>
                                            <form method="post" style="display: inline;" action="{% url 'teacher:reject_request' %}">
                                                {% csrf_token %}
                                                <input type="hidden" name="student_id" value="{{ student.id }}">
                                                <input type="hidden" name="action" value="reject">
                                                <button type="submit" class="action-btn reject-btn">
                                                    <i class="fas fa-times"></i>
                                                    Reject
                                                </button>
                                            </form>
                                        </div>
                                    </div>
                                {% endif %}
                            {% empty %}
                                <div class="empty-state">
                                    <i class="fas fa-inbox"></i>
                                    <h3>No Pending Requests</h3>
                                    <p>There are no students waiting to join your classes.</p>
                                </div>
                            {% endfor %}
                        {% else %}
                            <div class="empty-state">
                                <i class="fas fa-inbox"></i>
                                <h3>No Pending Requests</h3>
                                <p>There are no students waiting to join your classes.</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </section>
        {% endif %}
    </div>

    <section class="quick-actions-section">
        <h2>Quick Actions</h2>
        <div class="resources-grid">
            <div class="resource-card">
                <div class="resource-icon">
                    <i class="fas fa-plus fa-2x"></i>
                </div>
                <h3>Create Assignment</h3>
                <p>Create a new assignment for your students</p>
                <a href="{% url 'teacher:assignments' %}">
                    <button class="resource-btn">Create Now</button>
                </a>
            </div>

            <div class="resource-card">
                <div class="resource-icon">
                    <i class="fas fa-users-cog fa-2x"></i>
                </div>
                <h3>View Classes</h3>
                <p>Explore your class</p>
                <a href="{% url 'teacher:teacher_class' %}">
                    <button class="resource-btn">Explore Now</button>
                </a>
            </div>
        </div>
    </section>
</div>
{% endblock content %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {

    // Dashboard Layout Logic
    const dashboardColumns = document.querySelector('.dashboard-columns');
    const pendingRequestsSection = document.getElementById('pendingRequestsSection');
    
    const hasPendingRequests = pendingRequestsSection && 
        pendingRequestsSection.querySelector('.student-card') !== null;
    
    const isHeadTeacher = pendingRequestsSection !== null;
    
    if (!isHeadTeacher || !hasPendingRequests) {
        dashboardColumns.classList.add('single-column');
        
        if (pendingRequestsSection && !hasPendingRequests) {
            pendingRequestsSection.style.display = 'none';
        }
    }

    // Check if scrollable list needs scroll indicator
    const studentListContainer = document.getElementById('studentListContainer');
    const pendingStudentsList = document.getElementById('pendingStudentsList');
    
    if (pendingStudentsList && studentListContainer) {
        function checkScroll() {
            if (pendingStudentsList.scrollHeight > pendingStudentsList.clientHeight) {
                studentListContainer.classList.add('has-scroll');
            } else {
                studentListContainer.classList.remove('has-scroll');
            }
        }
        
        // Check on load
        checkScroll();
        
        // Check on scroll to hide indicator when at bottom
        pendingStudentsList.addEventListener('scroll', function() {
            const isAtBottom = pendingStudentsList.scrollHeight - pendingStudentsList.scrollTop <= pendingStudentsList.clientHeight + 10;
            if (isAtBottom) {
                studentListContainer.classList.remove('has-scroll');
            } else if (pendingStudentsList.scrollHeight > pendingStudentsList.clientHeight) {
                studentListContainer.classList.add('has-scroll');
            }
        });
        
        // Re-check on window resize
        window.addEventListener('resize', checkScroll);
    }

    // Enhanced Image Upload Functionality
    const uploadTrigger = document.getElementById('uploadTrigger');
    const uploadModal = document.getElementById('uploadModal');
    const closeModal = document.getElementById('closeModal');
    const cancelUpload = document.getElementById('cancelUpload');
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('profileFileInput');
    const filePreview = document.getElementById('filePreview');
    const previewImage = document.getElementById('previewImage');
    const fileInfo = document.getElementById('fileInfo');
    const fileName = document.getElementById('fileName');
    const fileSize = document.getElementById('fileSize');
    const fileType = document.getElementById('fileType');
    const validationMessage = document.getElementById('validationMessage');
    const uploadButton = document.getElementById('uploadButton');
    const profileUploadForm = document.getElementById('profileUploadForm');
    const currentProfileImage = document.getElementById('currentProfileImage');
    const profileContainer = document.getElementById('profileContainer');

    let selectedFile = null;

    // Format file size
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // Show validation message
    function showValidationMessage(message, type) {
        if (validationMessage) {
            validationMessage.innerHTML = message;
            validationMessage.className = `validation-message ${type}`;
            validationMessage.style.display = 'block';
        }
    }

    // Hide validation message
    function hideValidationMessage() {
        if (validationMessage) {
            validationMessage.style.display = 'none';
        }
    }

    // Validate file
    function validateFile(file) {
        // Check file type
        const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png'];
        if (!allowedTypes.includes(file.type)) {
            showValidationMessage('Please select a valid image file (JPEG, or PNG).', 'error');
            return false;
        }

        // Check maximum file size (200KB) - UPDATED
        const maxSize = 200 * 1024; // 200KB in bytes
        if (file.size > maxSize) {
            const currentSize = formatFileSize(file.size);
            showValidationMessage(`Image too large. Maximum size is 200KB. Your image is ${currentSize}.`, 'error');
            return false;
        }

        return true;
    }

    // Show file preview
    function showFilePreview(file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            if (previewImage) previewImage.src = e.target.result;
            if (fileName) fileName.textContent = file.name;
            if (fileSize) fileSize.textContent = `Size: ${formatFileSize(file.size)}`;
            if (fileType) fileType.textContent = `Type: ${file.type}`;
            
            if (filePreview) filePreview.classList.add('active');
            if (uploadButton) uploadButton.disabled = false;
            
            showValidationMessage('Image looks good! Ready to upload.', 'success');
        };
        reader.readAsDataURL(file);
    }

    // Handle file selection
    function handleFileSelect(file) {
        if (!file) return;

        selectedFile = file;
        hideValidationMessage();

        if (validateFile(file)) {
            showFilePreview(file);
        } else {
            if (filePreview) filePreview.classList.remove('active');
            if (uploadButton) uploadButton.disabled = true;
            selectedFile = null;
        }
    }

    // Reset modal
    function resetModal() {
        if (fileInput) fileInput.value = '';
        if (filePreview) filePreview.classList.remove('active');
        if (uploadButton) uploadButton.disabled = true;
        hideValidationMessage();
        selectedFile = null;
    }

    // Event Listeners
    
    // Open modal - Multiple ways to trigger
    if (uploadTrigger) {
        uploadTrigger.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            if (uploadModal) {
                uploadModal.classList.add('active');
                document.body.style.overflow = 'hidden';
            }
        });
    }

    // Also allow clicking the entire profile container
    if (profileContainer) {
        profileContainer.addEventListener('click', function(e) {
            e.preventDefault();
            if (uploadModal) {
                uploadModal.classList.add('active');
                document.body.style.overflow = 'hidden';
            }
        });
    }

    // Close modal
    function closeModalHandler() {
        if (uploadModal) {
            uploadModal.classList.remove('active');
            document.body.style.overflow = 'auto';
            resetModal();
        }
    }

    if (closeModal) closeModal.addEventListener('click', closeModalHandler);
    if (cancelUpload) cancelUpload.addEventListener('click', closeModalHandler);

    // Close modal on outside click
    if (uploadModal) {
        uploadModal.addEventListener('click', function(e) {
            if (e.target === uploadModal) {
                closeModalHandler();
            }
        });
    }

    // Close modal on Escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && uploadModal && uploadModal.classList.contains('active')) {
            closeModalHandler();
        }
    });

    // Drop zone click
    if (dropZone) {
        dropZone.addEventListener('click', function() {
            if (fileInput) fileInput.click();
        });
    }

    // File input change
    if (fileInput) {
        fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            handleFileSelect(file);
        });
    }

    // Drag and drop functionality
    if (dropZone) {
        dropZone.addEventListener('dragover', function(e) {
            e.preventDefault();
            e.stopPropagation();
            dropZone.classList.add('dragover');
        });

        dropZone.addEventListener('dragleave', function(e) {
            e.preventDefault();
            e.stopPropagation();
            dropZone.classList.remove('dragover');
        });

        dropZone.addEventListener('drop', function(e) {
            e.preventDefault();
            e.stopPropagation();
            dropZone.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                const file = files[0];
                if (fileInput) fileInput.files = files;
                handleFileSelect(file);
            }
        });
    }

    // Form submission - DJANGO VERSION (No API)
    if (profileUploadForm) {
        profileUploadForm.addEventListener('submit', function(e) {
            if (!selectedFile) {
                e.preventDefault();
                showValidationMessage('Please select an image first.', 'error');
                return;
            }

            if (!validateFile(selectedFile)) {
                e.preventDefault();
                return;
            }

            // Show loading state
            if (uploadButton) {
                uploadButton.disabled = true;
                uploadButton.textContent = 'Uploading...';
            }
            showValidationMessage('Uploading your image...', 'warning');
        });
    }

});
</script>
{% endblock %}